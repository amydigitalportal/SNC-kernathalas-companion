<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SNC Ker Nathalas Encounter Assistant</title>
    <link rel="stylesheet" href="styles.css">

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined"/>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" >

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Grenze+Gotisch:wght@100..900&family=Inconsolata:wght@200..900&family=Jacquard+24&family=Jim+Nightshade&family=Kings&family=Manufacturing+Consent&family=My+Soul&family=New+Rocker&family=Pirata+One&family=UnifrakturCook:wght@700&display=swap" rel="stylesheet">
    
    <!-- General Styles -->
    <style>
        .hidden {
            display: none !important;
        }

        .vertical-seperator {
            display: inline-block;
            width: 1px;
            min-height: 20px;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.25);
        }

         .material-symbols-outlined {
            font-variation-settings:
                'FILL' 0,
                'wght' 400,
                'GRAD' 0,
                'opsz' 24;
            font-size: 32px;
            color: white;
            vertical-align: middle;
        }

    </style>

    <!-- Header Styles -->
    <style>
        header {
            margin: 0;
            height: 56px;
            background-color: black;
        }

        header .viewmode-container {
            width: 100%;
            margin: 0 auto; /* Center the header */
            /* padding: 0 1.5rem; */
            align-content: center;
            height: 100%;
        }
        
        header ul {
            margin: 0;
            padding: 0;
            padding-top: 10px;
            list-style: none;
            display: flex;
            align-items: stretch;
            justify-content: center;
            /* gap: 1.5rem; */
        }

        header button {
            width: 80px;
            padding: 0;
            position: relative;
            cursor: pointer;
            border: none;
            color: rgba(255,255,255,0.5);
            background: none;
            font-size: 1rem;
            font-family: "New Rocker", system-ui;
            text-align: center;
            
            transition: color 0.15s ease-in-out; /* 👈 this enables the fade */
        }
        
        /* Red underline effect */
        header button::after {
            content: '';
            position: absolute;
            height: 4px;
            width: 100%;
            bottom: -12px;
            left: 50%;
            background-color: red;
            transform: translateX(-50%) scaleX(0); /* start from center */
            transform-origin: center;
            transition: transform 0.1s ease-in-out;
        }

        header button.active {
            color: rgba(255, 255, 255, 1.0); /* bright white */
        }
        
        /* Active state */
        header button.active::after {
            transform: translateX(-50%) scaleX(1); /* expand from center */
        }
        
        header .viewmode-button {
            height: 24px;
            padding-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>

    <style>
        body {
            margin: 0;
            background-image: url('assets/wallpaper.png');
            color: white;
            font-family: "Manufacturing Consent", system-ui;
        }

        .txt-shadow {
            text-shadow: 
                2px    2px    2px   rgba(0, 0, 0, 0.75),
                2px    0px    25px  rgba(0, 0, 0, 0.8), 
                0px   -2px    5px   rgba(0, 0, 128, 0.85);
        }

        .hero {
            text-align: center;
            margin: 0 auto;
            padding: 1.75rem;
            /* background-color: rgba(0, 0, 0, 0.5); */
            /* border-radius: 8px; */
            max-width: 800px;
        }

        .hero div {
            font-size: 1.5rem;
        }

        #hero-logo {
            width: 85%;
            height: auto;
            display: block;
            margin: 0 auto;
        }

        .page-title {
            text-align: center;
            padding: .5rem;
        }
        .page-title h1 {
            font-weight: normal;
            font-size: 3rem;
            text-shadow: 1px 4px 5px rgba(0, 0, 0, 1.0);
        }

        .instructions-tip {
            margin: 0 0;
            text-align: center;

            font-family: "Pirata One", system-ui;
            font-size: 1.2rem;
        }

        #button-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            width: 80%;
            margin: 0 auto;
            gap: 1rem;
        }

        #button-container > div > * {
            display: block;
            /* width: 100%; */
        }

        .button-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: .5rem;
            gap: 1rem;

            width: 80%;            /* 👈 set the width */
            margin: 0 auto;         /* 👈 center horizontally */

            /* background: rgba(0, 0, 0, 0.8); */
            background: rgba(34, 34, 34, 0.95);
            border: 1px solid #555;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .theme-button {
            /* background-color: #333;
            color: white; */
            background: linear-gradient(#3a2f1c, #1e1a14); /* dark brown to almost black */
            color: #e0d7c3; /* parchment-like font color */
            border: 2px solid #5c4c33;
            border-radius: 4px;
            font-family: "Grenze Gotisch", system-ui;
            font-size: 1rem;
            letter-spacing: 1px;
            
            padding: 0.6em 1.2em;
            box-shadow: inset 0 0 4px #00000088, 0 2px 4px #00000066;
            cursor: pointer;
            transition: all 0.1s ease-in-out;
        }
        .theme-button:hover {
            background: linear-gradient(#4a3b28, #2b231a);
            color: #fffbe0;
            transform: translateY(-1px);
            box-shadow: inset 0 0 6px #000000aa, 0 4px 8px #00000088;
        }

        .theme-button:active {
            transform: translateY(0px);
            box-shadow: inset 2px 2px 6px #000000aa;
        }

        .result-text {
            font-size: 1.5rem;
            font-family: "New Rocker", system-ui;
            /* Dark blood color for results */
            color: rgba(192, 0, 0, 0.8);
        }

        .flavor-text {
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            padding: 1rem 2rem;

            background-image: url('assets/kn-parchment.png');
            background-color: rgba(255,255,255,0.5);
            background-blend-mode: luminosity;
            
            color: black;
            font-size: 2rem;
            font-family: "Jim Nightshade", cursive;
            font-weight: 400;
            text-shadow: #4604048a 1px 1px 2px;

            width: 100%;
            box-sizing: border-box;    /* 👈 prevents overflow due to padding */
        }

        .flavor-text-wrapper {
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            padding: 1rem 2rem;

            background-image: url('assets/kn-parchment.png');
            background-color: rgba(255, 255, 255, 0.5);
            background-blend-mode: luminosity;
            background-size: cover;
            background-position: center;

            width: 100%;
            box-sizing: border-box;
        }

        .flavor-text-content {
            color: black;
            font-size: 2rem;
            font-family: "Jim Nightshade", cursive;
            font-weight: 400;
            text-shadow: #4604048a 1px 1px 2px;
        }

        /* UNUSED */
        .roll-all-button {
            padding: .3rem 2rem;
            padding-top: .5rem;
            font-size: 1.5rem;
            font-weight: bold;
            font-family: 'Kings', serif; /* medieval touch */
            color: #2c2323;
            /* text-transform: uppercase; */

            background: linear-gradient(145deg, #d4c821, #a68f45, #5a5625); /* aged gold gradient */
            border: 2px solid #3b3415;
            border-radius: 6px;

            box-shadow:
                inset 2px 2px 4px #2e280e,         /* inner dark carving (bottom-right) */
                inset -2px -2px 4px #e2c99e,      /* inner light highlight (top-left) */
                0 4px 8px rgba(0, 0, 0, 0.6),     /* outer shadow */
                0 0 0 2px #655521 inset;          /* faint inner rim */

            text-shadow:
                1px 1px 0 #9700004f,                   /* dark base emboss */
                -1px -1px 1px rgba(255, 255, 255, 0.267),              /* faint top-light highlight */
                0 2px 2px rgba(255, 240, 32, 0.733);                  /* soft outer text shadow */

            cursor: pointer;
            transition: all 0.2s ease;
            /* margin: 2rem auto; */
            display: block;
        }

        .roll-all-button:hover {
            transform: scale(1.02);
            filter: brightness(1.1);
            box-shadow:
                inset 3px 3px 6px #2e1e0e,
                inset -2px -2px 6px #e2c99e,
                0 6px 14px rgba(0, 0, 0, 0.7),
                0 0 0 2px #654321 inset;
        }
        
        .golden-button {
            touch-action: manipulation;
            display: inline-block;
            outline: none;
            font-family: 'Kings', serif; /* medieval touch */
            font-size: 1.5em;
            font-weight: bold;
            box-sizing: border-box;
            border: none;
            border-radius: 0.1em;
            /* height: 2.75em; */
            line-height: 2em;
            text-transform: uppercase;
            padding: 0 1em;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.16), 0 3px 6px rgba(110, 80, 20, 0.4),
                inset 0 -2px 5px 1px rgba(139, 66, 8, 1),
                inset 0 -1px 1px 3px rgba(250, 227, 133, 1);
            background-image: linear-gradient(
                160deg,
                /* #a54e07,
                #b47e11,
                #fef1a2,
                #bc881b,
                #a54e07 */
                #613d1f,
                #b98825,
                #fef1a2,
                #bc881b,
                #794c27
            );
            border: 1px solid #685927;
            color: rgb(112, 6, 6);
            text-shadow: 0 2px 2px rgba(250, 227, 133, 1);
            cursor: pointer;
            transition: all 0.1s ease-in-out;
            background-size: 100% 100%;
            background-position: center;
        }
        .golden-button:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(250, 227, 133, 0.5), inset 0 -2px 5px 1px #b17d10,
                inset 0 -1px 1px 3px rgba(250, 227, 133, 1);
        }
        .golden-button:hover {
            background-size: 150% 150%;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.19), 0 6px 6px rgba(0, 0, 0, 0.23),
                inset 0 -2px 5px 1px #b17d10, inset 0 -1px 1px 3px rgba(250, 227, 133, 1);
            border: 1px solid rgba(165, 93, 7, 0.6);
            color: rgb(124, 9, 5);
        }

        .golden-button:active {
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.16), 0 3px 6px rgba(110, 80, 20, 0.4),
                inset 0 -2px 5px 1px #b17d10, inset 0 -1px 1px 3px rgba(250, 227, 133, 1);
        }

    </style>

    <!-- Mechanisms Page Styles -->
    <style>
    .mechanisms-button-container {
        margin: 0 auto;
        display: flex;
        justify-content: space-evenly;
        align-items: center;
        width: 80%;
        max-width: 600px;
        gap: 2rem;
    }

    .mechanism-button {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: none;
        border: none;
        cursor: pointer;
        color: rgba(255, 255, 255, 1.0);
        transition: color 0.3s ease;
        font-size: 1.5rem;
    }

    .mechanism-button .material-icons {
        font-size: 4rem;
        margin-bottom: 0.5rem;
    }

    .mechanism-button:hover {
        color: rgba(255, 0, 0, 1);
    }

    .mechanism-report {
        margin: 2.5rem auto;
        margin-bottom: 0.5rem;
        padding: 12px;
        font-size: 1.2rem;
        text-align: center;
    }
    .mechanism-report .flavor-text {
        margin: 0;
    }

    .mechanism-is-locked {
        color: gold;
        font-weight: bold;
    }

    .mechanism-is-trapped {
        color: rgb(150, 9, 9);
        font-weight: bold;
    }

    .report-details-wrapper {
        /* width: 100%; */
        text-align: center;
        font-family: "New Rocker", serif;
        padding-bottom: 1rem;
    }

    .report-heading {
        color: #fff;
        font-size: 1.5rem;
        margin-bottom: 0;
        line-height: 0;
    }

    .difficulty-columns {
        margin-top: 1rem;
        display: flex;
        justify-content: center;
        gap: 2rem;
        flex-wrap: wrap;
    }

    .difficulty-column {
        background: black;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 6px;
        padding: 1rem 1.5rem;
        min-width: 160px;
        color: #fff;
    }

    .difficulty-label {
        font-weight: bold;
        margin-bottom: 0.25rem;
    }

    .difficulty-detail {
        margin-top: 1rem;
        font-style: italic;
        font-size: 1.2rem;
    }
    </style>


    <!-- Combat Page Styles  -->
    <style>
.combat-content-container {
    width: 100%;
    margin: 0 auto;
    display: flex;
    justify-content: center;
}
        
.combat-panel {
    padding: 1rem;
    background: rgba(34, 34, 34, 0.95);
    color: #eee;
    border: 1px solid #555;
    border-radius: 8px;
    width: 80%;
    font-weight: 400;
    font-family: "New Rocker", system-ui;
}

.combat-panel hr {
    margin: 1rem 0;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

#combat-players-panel {
    display: flex;
    align-items: center;
    flex-direction: column;
    gap: 1rem;
}

#combat-players-panel h2, h3 {
    line-height: 0;
}

#combat-players-panel .theme-button {
    padding: 0.5rem .5rem;
}

.player-count-wrapper {
    padding: 1rem;
}

.generate-activity-button-container {
    padding: 1rem 0;
    margin: 1rem auto;
    width: 100%;
}

.log-box {
    padding: 0.5rem;
    background: #111;
    border: 1px solid #444;
    min-height: 100px;
	max-height: 200px;       /* 👈 limit height */
	overflow-y: auto;        /* 👈 enable vertical scroll */
    overflow-x: hidden;
    overflow-wrap: break-word;  /* ✅ Ensures long words break properly */
    font-family: "Inconsolata", monospace;
}

.log-box ol {
    margin: 0;
    padding: 0;
    list-style: none;

    display: flex;
    flex-direction: column;
    align-items: flex-start;   /* left-align items */
    justify-content: flex-start; /* top-align items (default for column) */
    
}

.log-box ol li {
    margin-bottom: 0.5rem;   /* 👈 spacing between list items */
    text-align: left;      /* optional: center text inside li */
}

.log-box pre {
	white-space: pre-wrap;     /* ✅ allows wrapping */
	word-break: break-word;    /* ✅ helps break long tokens */
	overflow-wrap: break-word; /* ✅ extra robustness */
}

    </style>
</head>

<template id="themed-button-template">
    <button class="btn theme-button"></button>
</template>

<body>
    <header>
        <div class="viewmode-container">
            <ul>
                <li class="vertical-seperator"></li>
                <li>
                    <button class="viewmode-button" data-mode="HOME">
                        <!-- HOME -->
                        <span class="material-symbols-outlined">home</span>
                    </button>
                </li>
                <li class="vertical-seperator"></li>
                <li>
                    <button class="viewmode-button" data-mode="EXPLORATION">
                        <!-- EXPLORATION -->
                        <span class="material-symbols-outlined">footprint</span>
                    </button>
                </li>
                <!-- <li><button class="viewmode-button" data-mode="EXPLORATION">EXPLORATION</button></li> -->
                <li class="vertical-seperator"></li>
                <li>
                    <button class="viewmode-button" data-mode="MECHANISMS">
                        <!-- MECHANISMS -->
                        <span class="material-symbols-outlined">warning</span>
                    </button>
                </li>
                <li class="vertical-seperator"></li>
                <li>
                    <button class="viewmode-button" data-mode="COMBAT">
                        <!-- COMBAT -->
                        <span class="material-symbols-outlined">swords</span>
                    </button>
                </li>
                <li class="vertical-seperator"></li>
                <!-- <li><button class="viewmode-button" data-mode="COMBAT">COMBAT</button></li> -->
            </ul>

        </div>
    </header>

    <main>
        <div class="container">
            <div class="home-page">
                <div class="hero txt-shadow">
                    <div style="font-size: 1.5rem;">Squeak N Coozy's</div>
                    <img id="hero-logo" src="assets/kn-logo-borderized.png" alt="SNC Ker Nathalas Logo">
                    <div style="font-size: 2.5rem;">Encounter Assistant</div>
                </div>
                
                <!-- <p class="instructions-tip txt-shadow">Use the buttons below to roll dice or perform other actions.</p> -->
            </div>
            
            <div class="exploration-page hidden">
                <div class="exploration-header page-title txt-shadow">
                    <h1>Exploration Phase</h1>
                    <!-- <p>Roll to explore the dungeon and uncover its secrets.</p> -->
                </div>
            </div>

            <div class="mechanisms-page hidden">
                <div class="mechanisms-header page-title txt-shadow">
                    <h1>Dungeon Mechanisms</h1>
                    <!-- <p>Interact with the dungeon's mechanisms and traps.</p> -->
                </div>
                <div class="mechanisms-button-container">
                    <button id="door-mechanism-button" class="golden-button" onclick="this.blur(); rollDoorExamination();">
                        DOOR
                    </button>
                    <button id="container-mechanism-button" class="golden-button" onclick="this.blur(); rollContainerExamination();">
                        CONTAINER
                    </button>
                </div>
                <div class="mechanism-report button-group">
                    <div class="flavor-text-wrapper">
                        <div id="mechanism-message" class="flavor-text-content">Awaiting your examination ...</div>
                    </div>
                </div>
                <div id="mechanism-report-details" class="report-details-wrapper button-group hidden">
                    <h3 class="report-heading">Difficulty</h3>
                    <div id="difficulty-columns" class="difficulty-columns">
                        <!-- JS will populate lock/trap columns here -->
                    </div>
                </div>
            </div>

            <div class="combat-page hidden">
                <div class="combat-header page-title txt-shadow">
                    <h1>Combat Phase</h1>                    
                    <!-- <p>Engage in battles against the dungeon's denizens.</p> -->
                    <div class="combat-content-container">

                        <div class="combat-panel">
                            <h2>Combat Manager</h2>
                            <div id="combat-players-panel">
                                <h3>Players</h3>
                                <div class="button-row">  
                                    <button id="subtract-player-button" class="theme-button">
                                        <span class="material-symbols-outlined">remove</span>
                                    </button>
                                    <button id="add-player-button"class="theme-button">
                                        <span class="material-symbols-outlined">add</span>
                                        
                                    </button>
                                </div>
                                <button id="reset-players-button" class="theme-button" style="padding: 0 1rem; height: 2rem;">Reset</button>
                                <div class="player-count-wrapper">
                                    <!-- <span class="player-count-label">Players: </span>
                                    <span id="player-count-span">1</span> -->
                                    <div id="player-count-tracker" class="player-count-label">
                                        <span class="material-symbols-outlined">chess_pawn</span>
                                    </div>
                                </div>
                            </div>

                            <hr>

                            <div class="generate-activity-button-container">
                                <button id="generate-activity-button" class="theme-button">Generate Monster Action</button>
                            </div>

                            <div id="monster-log" class="log-box">
                                <span id="monster-log-placeholder-text">(No activities yet)</span>
                                <ol id="monster-log-activity-list" class="hidden"></ol>
                            </div>

                        </div>
                    </div>
                </div>
            </div>

        </div><!-- end of container -->

</html>

<!-- Declarations, Defs, General Functions -->
<script>

const CORRIDOR_DESCRIPTIONS = {
	1: "The air is heavy with ancient dust, and the walls are lined with cobwebs. The faint echoes of distant footsteps can be heard.",
	2: "Flickering torches cast eerie shadows on the stone walls. The air is damp, and the occasional drip of water can be heard.",
	3: "The tunnel is barely wide enough for a single person to pass through. The walls are lined with ancient burial niches, some of which have been disturbed. You're not sure if from within or without…",
	4: "Thick moss covers the damp stone walls, giving the corridor an eerie green glow. The sound of water dripping echoes throughout.",
	5: "The passage is partially blocked by a cave-in, with rubble and debris scattered across the floor. Dim light filters through cracks in the ceiling.",
	6: "The walls are adorned with elaborate tomb reliefs and carved epitaphs. The air feels heavy with the presence of the long-departed.",
	7: "The narrow stone hall twists and turns, disappearing into darkness. The hall seems to have a slight downwards inclination, and it feels worn and slippery.",
	8: "The air here is stale, and the sound of rats scurrying can be heard in the distance.",
	9: "An eerie silence fills this corridor, broken only by the faint whispers of long-dead spirits. The air is heavy with an otherworldly stillness.",
	10: "Strange luminescent fungi cover the walls, casting an ethereal glow. The tunnel twists and turns, creating an unsettling sense of disorientation.",
	11: "This wide corridor is lined with towering statues and ornate sarcophagi. Faded tapestries hang from the ceiling, telling stories of ancient rulers.",
	12: "The tunnel is partially submerged in water, with small ripples disturbing its still surface. The faint odor of decay permeates the air.",
	13: "A hidden alcove branches off from the main passage, housing a forgotten altar or a small shrine. Dust-covered offerings lie undisturbed.",
	14: "Strange symbols are etched onto the walls of this hall, possibly indicating directions.",
	15: "The walls of this tunnel bear scorch marks, evidence of past fire or magical explosions. The air carries a faint smell of burnt wood and stone.",
	16: "Time and decay have taken their toll on this corridor, with crumbling walls and ceilings. It feels unstable and prone to collapse.",
	17: "Faint whispers and hushed voices fill the air, voices carried through time.",
	18: "The stench of decay is overpowering in this tunnel, infested with ravenous vermin that lurk in the shadows.",
	19: "Intricate carvings adorn the walls, depicting scenes of ancient rituals and funerary rites. The air is heavy with a sense of solemnity and reverence.",
	20: "The corridor seems to shimmer with an otherworldly glow. Transparent figures of long-dead souls can be seen drifting through the walls, oblivious to the living."
};

const ROOM_DESCRIPTIONS = {
	1: "Rusty iron shackles hang from the walls, and the floor is littered with the remains of those who suffered unspeakable agony.",
	2: "This regal hall is filled with shattered marble thrones, a stark reminder of the empire's fallen rulers and the broken legacy they left behind.",
	3: "Eerie whispers fill the air in this dimly lit crypt, where the tormented spirits of the empire's cursed rulers still roam in eternal restlessness.",
	4: "The stone altar in the center of the room is covered in dried blood, a chilling testament to the dark rituals that once took place here.",
	5: "A vast network of burial niches houses the remains of countless forgotten souls, their existence erased from history.",
	6: "Chains of all sizes hang from the ceiling, the clinking sound echoing like a haunting melody in this hall of imprisonment.",
	7: "Sculptures of mournful figures adorn the walls, each seemingly caught in an eternal state of sorrow and despair.",
	8: "The room is perpetually shrouded in darkness, where even torches struggle to dispel the oppressive gloom.",
	9: "Tombstones and coffins line the walls, bearing the names of lovers separated by death, forever longing for each other's embrace.",
	10: "Useless trinkets and baubles lie scattered about, remnants of the once-great Vaelorian Ascendancy now reduced to forgotten relics.",
	11: "This room seems to have been blasted by a source of water for millennia, since all the surfaces are smooth and slippery.",
	12: "An opulent throne sits empty in the center of this chamber, surrounded by dust and decay, a symbol of the empire's fallen glory.",
	13: "Echoes of anguished cries reverberate through this room, as if the walls themselves are weeping for the tragedies that unfolded within.",
	14: "Foul, withered plants and skeletal trees twist and reach for sunlight that will never touch them.",
	15: "A pitch-black room that gives the illusion of extending infinitely downward, leaving those who enter with an overwhelming sense of dread.",
	16: "This crypt room holds the remains of those cursed to eternal damnation, their souls forever trapped in this unholy place.",
	17: "A massive, ominous statue looms over the room, depicting a malevolent deity once worshiped by the empire's rulers.",
	18: "Ghostly apparitions drift through these halls, their faint whispers offering cryptic warnings and messages.",
	19: "An ancient stone altar dominates the room, surrounded by blood-stained grooves where countless offerings met their end.",
	20: "This room houses the remains of traitors and turncoats, eternally damned for their betrayal of the empire.",
	21: "Dark, arcane symbols cover the walls, hinting at the dark rituals once conducted within these unhallowed grounds.",
	22: "The bones of the empire's most wicked are piled high in this macabre display of death's inevitability.",
	23: "An eerie ticking fills the air as an ancient, enchanted clock counts down the minutes to oblivion.",
	24: "Any sound uttered within this hall fades into nothingness, as if the room devours all noise.",
	25: "Broken vials, shattered beakers, and rotting experiments reveal an alchemist's ill-fated pursuit of forbidden knowledge.",
	26: "Ancient scrolls and tomes rest on dust-covered shelves. Touching any of them quickly turns them into piles of dust.",
	27: "The stench of death hangs heavy in this room. Judging by some carvings, the Vaelorians disposed of their enemies in mass graves right here.",
	28: "A morbid altar stands before a statue of a martyr who endured unimaginable pain in the name of faith.",
	29: "The remains of a once-grand spire lie in ruin, a monument to a forgotten hero of the Vaelorian Ascendancy.",
	30: "As you enter this room, haunting visions and terrifying illusions assault you.",
	31: "Dark rituals once performed here have left an indelible mark on the walls, perpetually tainted by the essence of necromancy.",
	32: "The shadows of tormented souls replay their darkest moments in an eternal loop, forever haunted by their past actions.",
	33: "Ancient weapons and armor line the walls, too old and brittle to be of any use to you.",
	34: "The walls bear ghostly imprints of anguished faces, as if the room captures the final moments of those who met a tragic end.",
	35: "Shadows move independently from their sources, dancing across the walls like malevolent spirits.",
	36: "A still, black pool reflects the darkest aspects of one's soul, showing the horrors hidden within.",
	37: "Mirrors shattered into jagged pieces create a disorienting effect, distorting reality and reflecting haunting images.",
	38: "An eerie aura permeates this room, where the empire once sought answers from a cryptic and enigmatic oracle.",
	39: "Statues of macabre figures surround a central platform, where dark ceremonies once called upon malevolent powers.",
	40: "A large crack in the room's floor reveals a deep, dark abysm.",
	41: "This room holds within it an unholy shrine dedicated to dark forces.",
	42: "No sound can be heard in this room, not even the slightest whisper, creating an unsettling atmosphere of absolute quiet.",
	43: "This seems to be the final resting place of an emperor who history has forgotten, his name erased from all records.",
	44: "Broken chandeliers hang from the ceiling, and tattered banners once heralded celebrations now lay in ruin.",
	45: "Heat emanates from this room, and you can see the glow of lava in a corner, the viscous material dripping from a crack on the wall.",
	46: "An eerie, dim light filters through an enchanted glass ceiling, casting an otherworldly twilight over the room.",
	47: "Mirrors made from dark, reflective obsidian distort your reflection, your lightsource casting haunting shadows.",
	48: "Shrines to deities long abandoned by worshippers now stand in silence, their names etched into forgotten prayer tablets.",
	49: "Ancient telescopes and stargazing instruments remain untouched, though the stars they once observed have long changed.",
	50: "A once-powerful empress was buried here, her empty sarcophagus adorned with gilded glyphs.",
    51: "The room is plagued by an unnatural, freezing chill that numbs the bones as soon as you enter.",
	52: "Broken vials and failed experiments litter the room, reminders of the desperate and deadly alchemical pursuits.",
	53: "An overgrown courtyard now serves as a graveyard, with tombstones dotting the landscape where once joyous celebrations took place.",
	54: "Twisted and grotesque sculptures rest on pedestals, each representing the artist's descent into madness.",
	55: "The apparitions of those who died seeking revenge are trapped in this room, their anger seething for eternity.",
	56: "Taxidermy displays of long-extinct creatures and monstrous beasts line the walls, their glass eyes seemingly alive.",
	57: "The faint sounds of mournful music fill the air, emanating from unseen instruments in this haunted room.",
	58: "This chamber once housed the living quarters of a family of servants. Faint children's drawings can be seen on the walls.",
	59: "This room houses a shrine dedicated to a lunar deity. Its worshipers once performed heinous acts under the cursed moon's glow.",
	60: "A large crypt, where the sound of mourning and weeping echoes endlessly.",
	61: "A chamber once dedicated to studying the stars, now abandoned and covered in dust.",
	62: "Phantom weapons float in the air, suspended in an unsettling display of ethereal power.",
	63: "Plans for grand structures, some never built, while others bore terrible secrets, now rest here with the remains of their creator.",
	64: "Statues of once-lovely nymphs are now twisted and grotesque, surrounded by thorns and brambles.",
	65: "This once-imposing chamber is now decayed and crumbling, a symbol of the empire's decline.",
	66: "A series of arcane symbols that you've never encountered before cover the walls of this chamber.",
	67: "Phantom wails fill the air, as the spirits of wronged women lament their tragic fates.",
	68: "An ancient, corrupted forge where weapons were crafted from the souls of the fallen.",
	69: "The statues of weeping angels line this hall, their faces eternally frozen in grief.",
	70: "The resting place of an heir to the empire, whose lineage has been lost to history.",
	71: "The walls are adorned with eerie petrified faces that seem to whisper secrets to those who listen.",
	72: "This chamber is made entirely of black stone, and any light that enters is quickly swallowed by its darkness.",
	73: "An ornate stone chalice sits on an altar. It appears to have been fused to it by some extreme heat.",
	74: "This room's walls are covered with the tattered remains of ancient heraldic banners.",
	75: "At the center of this room, a seemingly bottomless pit drops into the darkness, its true depth a mystery that strikes fear into your heart.",
	76: "An otherworldly mist fills the room, giving glimpses of fleeting, forgotten dreams from the past.",
	77: "A cursed oracle once dwelt here, their prophecies leading to doom and despair for those who sought answers.",
	78: "A dark and foreboding courtyard where twisted shadows play tricks on the mind.",
	79: "The room is filled with the remains of lovers forever entwined in death, their skeletal hands locked in an eternal embrace.",
	80: "An otherworldly chamber where the boundaries between dimensions blur, allowing glimpses into distant realms.",
	81: "Horrifying paintings and sculptures depict scenes of unimaginable suffering and torment.",
	82: "This room has a well in a corner, but the water within it is clearly tainted with an eerie glow.",
	83: "This chamber is completely covered in fungi and mold of all kinds, making every step feel as if you're walking on a thick rug.",
	84: "Small, empty cells line the walls of this room.",
	85: "The walls are adorned with macabre paintings depicting brutal executions and violent sacrifices.",
	86: "Sealed off for centuries, this room contains unspeakable horrors that were best left undisturbed.",
	87: "An eerie fountain still trickling water is at the center of the room, a peaceful, almost out of place view.",
	88: "Disorienting illusions assault you momentarily as you step into this room, showing you images of your past.",
	89: "This room was once a treasure vault filled with riches, but it has long since been ransacked.",
	90: "A once-lavish parlor now lies in ruin, its grandeur replaced by decay and the stench of death.",
	91: "Rotten piles of furniture and rusted utensils are all you can see in this room.",
	92: "The walls are covered in soot and fire marks, clearly indicating that a great fire took place here.",
	93: "This room is completely empty, except for a thick layer of dust. A set of human footprints can be seen across the room.",
	94: "As you enter this hall you feel an overwhelming sense of hopelessness, as if all optimism is slowly being drained from your heart.",
	95: "A chamber adorned with gold and jewels. A closer look reveals them to be just paint and glass.",
	96: "A once-revered shrine now stands in darkness, forgotten by all but malevolent entities.",
	97: "Statues of ancient warriors stand guard, their once-pristine surfaces now marred by crimson stains.",
	98: "Old iron ingots are piled in a corner of this room, each one of them marked with the seal of an ancient house.",
	99: "An unnatural wind seems to be constantly coming out of this room, violently flapping your clothes and gear around you.",
	100: "An unquenchable, ghostly flame flickers and dances, casting eerie shadows on the walls, forever burning but never consuming."
};

const EVENTS = {
	1: "There's a trap in this room. Roll on the Traps table and follow the usual procedures.",
	11: "There's something of value here. Roll on the Spoils table.",
	21: "You've found a trader. Check page 221 to learn more about them.",
	31: "Altar of Sacrifice - Dyxemis. This altar is dedicated to the Vaelorian god of Pain. Sacrifice 1 Health to gain +5 max Toughness for the next D10+2 rooms or corridors.",
	32: "Altar of Sacrifice - Voteus. This altar is dedicated to the Vaelorian goddess of War. Sacrifice 1 Health to gain +10 to all attack rolls for the next D10+2 rooms or corridors.",
	33: "Altar of Sacrifice - Udall. This altar is dedicated to the Vaelorian goddess of Fury. Sacrifice 1 Health to gain +D4 Fire damage for the next D10+2 rooms or corridors.",
	34: "Altar of Sacrifice - Koias. This altar is dedicated to the Vaelorian god of Magic. Sacrifice 1 Health to gain +5 max Aether for the next D10+2 rooms or corridors.",
	35: "Altar of Sacrifice - Keasis. This altar is dedicated to the Valerian goddess of Peace. Sacrifice 1 Health to recover D4 Sanity.",
	36: "The ground and ceiling shake, showering you in dust and pebbles. Make a successful Endurance check to avoid gaining 1 Exhaustion.",
	37: "A voice within questions your need for coins. Make a Resolve check or lose D100₵.",
	38: "You enter a room full of human bones. Make a Resolve check to avoid losing 1 Sanity. Then make a Dodge check. If you pass, gain 10 XP and roll on the Spoils table. If you fail, take 2D6 Bludgeoning damage.",
	39: "You find strange markings. Make a Reason check: on success, gain 10 XP. On failure, you are ambushed—roll on the Combat Encounter table.",
	40: "A recent massacre. Make a Resolve check each time you enter to avoid losing 2 Sanity. You can attempt to scavenge twice.",
	41: "You find a beggar. Make a Reason check: if you pass, help him and roll on the Spoils table. If you fail, a necropede bursts from his chest and attacks!",
	42: "This room seems like a smuggler's hideout. Make an Athletics check. On success, roll on the Spoils table.",
	43: "You find a mangled body. Make a Perception check. On success, gain a charm (+D4 Fire damage for one room).",
	44: "A stream of blood pours from a wall. Make a Reason check. On success, gain 10 XP. On failure, take 3D4 Acid damage.",
	45: "You find a drained corpse. Make a Perception check: roll on the Spoils table. Then make a Dodge check. On failure, gain the Bleeding condition.",
	46: "You encounter a mutilated man. Help: Medicine check + Bandage → gain 20 XP. Ignore: lose 1 Sanity.",
	47: "A sigil is painted in blood. Attempt a Reason check to decipher it. On success, gain 20 XP. On failure, lose D4 Sanity (no Resolve check).",
	48: "A pool of water holds a glimmer. Make an Acrobatics check. On success, roll on the Spoils table. On failure, fall in and roll on the Growing Darkness table.",
	49: "A hole in the wall tempts you. Make an Athletics check. On success, roll on the Spoils table. On failure, take 2D6 Slashing damage as something pulls you in.",
	50: "A bell tolls in your mind. Make a Resolve check. On success, gain 20 XP. On failure, roll on either the Growing Darkness or Madness table.",
    51: "This room has been turned into a makeshift mausoleum. Desecrate the tomb to lose 1 Sanity and roll on the Spoils table, or say a prayer to regain D4 Sanity.",
	52: "A twisted effigy of human remains emits dark energy. Make a Resolve check: on success, gain 10 XP. On failure, cut yourself and take 3D4 Slashing damage.",
	53: "A trio of hanged men fills the room with the smell of death. Bury them: gain 2 Exhaustion and recover D4 Sanity. Ignore them: roll on the Growing Darkness table.",
	54: "Ghostly whispers fill your ears. Make a Reason check: on success, gain 10 XP. On failure, lose 1 Sanity.",
	55: "The room is littered with funerary vases. You can scavenge up to 3 times here.",
	56: "You witness your own death and must pass a Resolve check or lose D6 Sanity. If you fail, you may ignore the next source of Health loss that would bring you to 0.",
	57: "A statue of Vaelorian nobility judges you. Pass a Resolve check to roll twice on the Spoils table, or destroy the statue to remove an active Event.",
	58: "You find a quiet fountain. Take a moment to refresh and lose D4 Exhaustion.",
	59: "Ghostly flames roam the room. Each time you enter, make a Dodge check or lose 1 Sanity.",
	60: "A pile of scrolls reveals the Overseer's weakness. Make a Reason check: on success, Stun the Overseer in the first round of combat.",
	61: "The room is covered in fencing mosaics. Make a Reason check: on success, increase your Bladed Weapons skill by 1.",
	62: "A furious specter curses you. Make a Resolve check: on success, gain 10 XP. On failure, lose 1 Sanity and gain 1 Exhaustion.",
	63: "You find a tomb robber's camp. Make a Perception check: on success, gain D4 torches and D10 Crafting Supplies.",
	64: "You come across a terrible altar. Defile it with an Athletics check to remove an Event. On failure, attract attention—roll on the Combat Encounters table.",
	65: "You hear undead approaching. Make a Stealth check: on success, gain 20 XP. On failure, discard an item to distract them.",
	66: "A holy sigil resets the Tension Die back to D8.",
	67: "A meditation spot invites you to kneel. Make a Resolve check: on success, recover D4 Sanity. On failure, lose 1 Sanity.",
	68: "An angry spirit demands restitution. Make a Resolve check: on success, gain 10 XP. On failure, lose D100₵.",
	69: "A spirit tries to possess you. Make a Resolve check: on success, gain 20 XP. On failure, you must sacrifice a magic item or lose 1 Sanity per room.",
	70: "Magical devices shock you as you pass between them. Make an Acrobatics check to avoid 2D6 Air damage.",
	71: "A pile of refuse may hold treasure. Make a Perception check: on success, roll on the Spoils table.",
	72: "You interrupt a summoning. Make a Stealth check: on success, eliminate the warlock and recover D4 Sanity. On failure, gain 2 Exhaustion and roll on the Growing Darkness table.",
	73: "An alchemy lab is scattered with glass and chemicals. Make a Perception check: on success, find D4 Potions. On failure, find one usable potion.",
	74: "You find a bag's contents and its owner's corpse. Make a Perception check: on success, roll on the Spoils table. On failure, roll on the Combat Encounters table.",
	75: "A wall puzzle challenges you. Make a Reason check: on success, find 2D100₵.",
	76: "A hole full of viscera might contain loot. Make a Perception check: on success, roll on the Spoils table. On failure, lose 1 Sanity.",
	77: "A former holding cell has remains. Open the gate with an Athletics check to find a corpse and roll on the Spoils table.",
	78: "Strange herbs grow here. Make a Medicine check: on success, gain healing herbs for 2D6 Wounds.",
	79: "Thick mud slows your progress. Make an Athletics check: for each failure, gain 1 Exhaustion.",
	80: "Arcane sigils tempt you to study them. Make a Reason check: on success, ignore the next Growing Darkness roll. On failure, take 2D6 Arcane damage.",
	81: "Vampire bats swarm you. Make a Dodge check or take 2D4 Slashing damage. Also make an Endurance check or contract the Rot.",
	82: "You feel divine pressure. Hesie, Goddess of Purity, restores D6 Sanity.",
	83: "An invisible force attacks. Make a combat check: on success, gain 10 XP. On failure, take D12 Bludgeoning damage.",
	84: "A demonic fountain tempts you. Drink to take 2D6 Infernal damage and recover D6 Sanity.",
	85: "Two mysterious doors appear. The left leads to the Overseer's lair (reduce Lair Die). The right heals D10 Toughness but triggers a Growing Darkness roll.",
	86: "A pond conceals treasure. Make an Athletics check: on success, gain 3D20₵. On failure, see a hideous reflection and lose 1 Sanity.",
	87: "A waterfall masks danger. Make a Perception check: on success, avoid ambush. On failure, roll on the Combat Encounters table.",
	88: "Vines with berries grow here. Eat one: 1-3 recover 5 Exhaustion, 4-6 take 3D4 Poison damage.",
	89: "Bones litter the floor. Make an Acrobatics check: on failure, take D10 Bludgeoning damage. On success, roll on the Spoils table.",
	90: "An unstable artifact shakes violently. Make a Reason check: on success, deactivate it and gain 10 XP. On failure, take 5D4 Bludgeoning damage next Growing Darkness trigger.",
	91: "You find an old journal. Make a Reason check: on success, ignore the next Growing Darkness event.",
	92: "A crude map is scrawled on the wall. Make a Reason check: on success, pre-generate the next 3 rooms.",
	93: "A floating blood orb grants D10 temporary Aether but makes you lose initiative in your next combat.",
	94: "Dancing flames foretell your fate. Make a Resolve check: on success, gain 10 XP and pre-roll 3 Combat Encounters. On failure, gain the Burning condition.",
	95: "A bronze chain hangs ominously. Make an Athletics check: on success, gain 20 XP. On failure, the next enemy has +20 Combat Skill.",
	96: "A skeletal figure's message warns you. Make a Reason check: on success, gain +20 Initiative in your next combat.",
	97: "A hand grabs your ankle. Accept its deal to lose D4 max Sanity and gain D4 max Toughness.",
	98: "The room is lined with iron spikes. Make an Acrobatics check or gain the Bleeding condition.",
	99: "Volcanic heat overwhelms you. Gain D6 Exhaustion.",
	100: "A necrolord grabs your head. Make a Resolve check: on success, gain 100 XP. On failure, roll on the Madness table."
};

const MONSTERS = {
	"Abyssal Vexator": { page: 122 },
	"Amalgam": { page: 123 },
	"Armor Construct": { page: 124 },
	"Astral Beast": { page: 125 },
	"Bladewings": { page: 126 },
	"Blood Stalker": { page: 127 },
	"Blightfang Rats": { page: 128 },
	"Bone Golem": { page: 129 },
	"Bone Spiders": { page: 130 },
	"Cavebound Leech": { page: 131 },
	"Corpse Ants": { page: 132 },
	"Death Sage": { page: 133 },
	"Desiccated Cryptguards": { page: 134 },
	"Dwerax": { page: 135 },
	"Fangvine": { page: 136 },
	"Flayed Knight": { page: 137 },
	"Flesh Eater": { page: 138 },
	"Fleshmelt Slime": { page: 139 },
	"Giant Spider": { page: 140 },
	"Hive Larvae": { page: 141 },
	"Hive Warrior": { page: 142 },
	"Hollow Shambler": { page: 143 },
	"Living Moss": { page: 144 },
	"Necropede": { page: 145 },
	"Netherfiend": { page: 146 },
	"Plaguebringer": { page: 147 },
	"Pyreborn": { page: 148 },
	"Ratkin Marauders": { page: 149 },
	"Razorjaw": { page: 150 },
	"Reanimated Homunculus": { page: 151 },
	"Rotwalkers": { page: 152 },
	"Skeletal Horrors": { page: 153 },
	"Stone Warden": { page: 154 },
	"Swarmer": { page: 155 },
	"Tomb Crawler": { page: 156 },
	"Umbra Fiend": { page: 157 },
	"Unfettered Familiar": { page: 158 },
	"Vaelorian Magus": { page: 159 },
	"Vinekin": { page: 160 },
	"Voidweaver": { page: 161 },
	"Vorleg": { page: 162 },
	"Wraithskull": { page: 163 },
	"Wrath Elemental": { page: 164 }
};

const MONSTER_TABLES = Object.freeze({
	A: Object.freeze({
		1: "Abyssal Vexator",
		2: "Amalgam",
		3: "Armor Construct",
		4: "Astral Beast",
		5: "Bladewings",
		6: "Blood Stalker",
		7: "Bone Golem",
		8: "Bone Spiders",
		9: "Cavebound Leech",
		10: "Corpse Ants",
		11: "Death Sage",
		12: "Desiccated Cryptguards",
		13: "Dwerax",
		14: "Fangvine",
		15: "Flayed Knight",
		16: "Fleshmelt Slime",
		17: "Giant Spider",
		18: "Hive Larvae",
		19: "Hive Warrior",
		20: "Hollow Shambler"
	}),
	B: Object.freeze({
		1: "Living Moss",
		2: "Necropede",
		3: "Netherfiend",
		4: "Plaguebringer",
		5: "Pyreborn",
		6: "Ratkin Marauders",
		7: "Razorjaw",
		8: "Reanimated Homunculus",
		9: "Rotwalkers",
		10: "Stone Warden",
		11: "Swarmer",
		12: "Tomb Crawler",
		13: "Umbra Fiend",
		14: "Unfettered Familiar",
		15: "Vaelorian Magus",
		16: "Vinekin",
		17: "Voidweaver",
		18: "Vorleg",
		19: "Wraithskull",
		20: "Wrath Elemental"
	})
});




function createButton({ id, text, classList = [], onClick }) {
	const template = document.getElementById("themed-button-template");
	const clone = template.content.cloneNode(true);
	const button = clone.querySelector("button");

	button.id = id;
	button.textContent = text;
	classList.forEach(cls => button.classList.add(cls));
	if (typeof onClick === "function") {
		button.addEventListener("click", onClick);
	}
	return button;
}

function createTextSpan({ id, text = "-", classList = [] }) {
	const span = document.createElement("span");
	span.id = id;
	span.textContent = text;
	classList.forEach(cls => span.classList.add(cls));
	return span;
}

function createButtonGroup({ id, text, range, onClick }) {
	const groupWrapper = document.createElement("div");
	groupWrapper.id = id;
	groupWrapper.classList.add("button-group");

	const resultSpan = createTextSpan({
		id: `${id}-result`,
		text: "-",
		classList: ["text", "result-text"]
	});

	const flavorSpan = createTextSpan({
		id: `${id}-flavor`,
		text: "",
		classList: ["text", "flavor-text"]
	});
    hideElement(flavorSpan); // Hide flavor text initially

	const button = createButton({
		id: `${id}-btn`,
		text,
		classList: ["btn", "theme-button"],
		onClick: () => onClick(resultSpan, flavorSpan)
	});

	groupWrapper.appendChild(button);
	groupWrapper.appendChild(resultSpan);
	groupWrapper.appendChild(flavorSpan);
	return groupWrapper;
}

function randomNumber(min, max) {
    return Math.floor(Math.random() * max) + min;
}

function resetButtonGroup(id) {
	const resultEl = document.getElementById(`${id}-result`);
	const flavorEl = document.getElementById(`${id}-flavor`);
	if (resultEl) resultEl.textContent = "-";
	if (flavorEl) {
        flavorEl.textContent = "";
        flavorEl.classList.add("hidden"); // Hide flavor text when resetting
    }
}

function showGroup(id) {
	const el = document.getElementById(id);
	if (el) el.classList.remove("hidden");
}

function hideGroup(id) {
	const el = document.getElementById(id);
	if (el) {
		el.classList.add("hidden");
		resetButtonGroup(id); // ⬅️ Reset when hidden
	}
}

function resetAllGroups(groupIds) {
	groupIds.forEach(hideGroup); // hides and resets
}

function hideElement(element) {
    if (element) {
        element.classList.add("hidden");
    }
}

function showElement(element) {
    if (element) {
        element.classList.remove("hidden");
    }
}
</script>


<!-- SPA State Scripts -->
<script>
var monsterTableResult = '';
window.rollContext = {}; // Track state between rolls

const homePage = document.querySelector('.home-page');
const explorationPage = document.querySelector('.exploration-page');
const mechanismsPage = document.querySelector('.mechanisms-page');
const combatPage = document.querySelector('.combat-page');

const PAGES = {
    HOME: homePage,
    EXPLORATION: explorationPage,
    MECHANISMS: mechanismsPage,
    COMBAT: combatPage
};
</script>

<!-- Main Execution Scripts -->
<script>
window.onload = () => {
    initExplorationPage();
    initMechanismsPage();
    initCombatPage();
};
</script>

<!-- Exploration Page Scripts -->
<script>
function initExplorationPage() {
    const btnContainer = document.createElement("div");
    btnContainer.id = "button-container";
    explorationPage.appendChild(btnContainer);

    const phaseGroups = [
        "encounter-group",
        "monster-table-group",
        "monster-select-group",
        "event-group"
    ];

    // GOLDEN ROLL ALL BUTTON
    const rollAllButton = document.createElement("button");
    rollAllButton.textContent = "Roll ALL";
    // rollAllButton.classList.add("roll-all-button");
    rollAllButton.classList.add("golden-button");
    btnContainer.appendChild(rollAllButton);

    // Phase 1: Exploration
    const explorationGroup = createButtonGroup({
        id: "exploration-group",
        text: "Exploration (d100)",
        range: [1, 100],
        onClick: (result, flavor) => {
            const roll = randomNumber(1, 100);
            const isRoom = roll > 25;
            result.textContent = `${isRoom ? "Room" : "Corridor"} # ${roll}`;
            flavor.textContent = isRoom
                ? ROOM_DESCRIPTIONS[roll] || "A silent and empty room."
                : CORRIDOR_DESCRIPTIONS[Math.ceil((roll / 25) * 20)] || "The corridor is eerily quiet.";
            showElement(flavor);

            resetAllGroups(phaseGroups);
            window.rollContext.isRoom = isRoom;

            showGroup("encounter-group");
        }
    });
    btnContainer.appendChild(explorationGroup);

    // Phase 2: Encounter
    const encounterGroup = createButtonGroup({
        id: "encounter-group",
        text: "Encounter (d20)",
        range: [1, 20],
        onClick: (result, flavor) => {
            const roll = randomNumber(1, 20);
            result.textContent = roll;

            const isRoom = window.rollContext.isRoom;
            const encounterThreshold = isRoom ? 10 : 15;

            if (roll >= encounterThreshold) {
                resetButtonGroup("monster-table-group");
                resetButtonGroup("monster-select-group");
                showGroup("monster-table-group");
                hideGroup("event-group");
                hideGroup("monster-select-group");
            } else {
                resetButtonGroup("event-group");
                showGroup("event-group");
                hideGroup("monster-table-group");
                hideGroup("monster-select-group");
            }
        }
    });
    encounterGroup.classList.add("hidden");
    btnContainer.appendChild(encounterGroup);

    // Phase 3a: Monster Table
    const monsterTableGroup = createButtonGroup({
        id: "monster-table-group",
        text: "Monster Table (d6)",
        range: [1, 6],
        onClick: (result, flavor) => {
            const roll = randomNumber(1, 6);
            result.textContent = roll;
            flavor.textContent = roll <= 3 ? "Table A" : "Table B";

            monsterTableResult = roll <= 3 ? "A" : "B";
            const monsterButton = document.getElementById("monster-select-group-btn");
            if (monsterButton) {
                monsterButton.textContent = `Monster (Table ${monsterTableResult} - d20)`;
                resetButtonGroup("monster-select-group");
            }
            showElement(flavor);
            showGroup("monster-select-group");
        }
    });
    monsterTableGroup.classList.add("hidden");
    btnContainer.appendChild(monsterTableGroup);

    // Phase 3b: Monster Select
    const monsterSelectGroup = createButtonGroup({
        id: "monster-select-group",
        text: "Monster (d20)",
        range: [1, 20],
        onClick: (result, flavor) => {
            const roll = randomNumber(1, 20);
            result.textContent = roll;

            const table = MONSTER_TABLES[monsterTableResult];
            const monster = table[roll] || "ERROR - INVALID ENTRY FROM MONSTER_TABLES";

            flavor.textContent = `${monster} (p. ${121 + roll})`;
            showElement(flavor);
        }
    });
    monsterSelectGroup.classList.add("hidden");
    btnContainer.appendChild(monsterSelectGroup);

    // Phase 3c: Event
    const eventGroup = createButtonGroup({
        id: "event-group",
        text: "Event (d100)",
        range: [1, 100],
        onClick: (result, flavor) => {
            const roll = randomNumber(1, 100);
            result.textContent = roll;

            const event = (roll <= 10) ? 1 : (roll <= 20) ? 11 : (roll <= 30) ? 21 : roll;
            flavor.textContent = EVENTS[event] || "ERROR - INVALID ENTRY FROM EVENTS";
            showElement(flavor);
        }
    });
    eventGroup.classList.add("hidden");
    btnContainer.appendChild(eventGroup);

    // ROLL ALL FUNCTION
    rollAllButton.onclick = () => {
        rollAllButton.blur(); // Remove focus from the button
        
        // Exploration
        const explorationRoll = randomNumber(1, 100);
        const isRoom = explorationRoll > 25;
        window.rollContext.isRoom = isRoom;

        const explorationResult = document.querySelector("#exploration-group .result-text");
        const explorationFlavor = document.querySelector("#exploration-group .flavor-text");
        explorationResult.textContent = `${isRoom ? "Room" : "Corridor"} # ${explorationRoll}`;
        explorationFlavor.textContent = isRoom
            ? ROOM_DESCRIPTIONS[explorationRoll] || "A silent and empty room."
            : CORRIDOR_DESCRIPTIONS[Math.ceil((explorationRoll / 25) * 20)] || "The corridor is eerily quiet.";
        showElement(explorationFlavor);

        resetAllGroups(phaseGroups);
        showGroup("encounter-group");

        // Encounter
        const encounterRoll = randomNumber(1, 20);
        const encounterResult = document.querySelector("#encounter-group .result-text");
        encounterResult.textContent = encounterRoll;

        const encounterThreshold = isRoom ? 10 : 15;
        if (encounterRoll >= encounterThreshold) {
            // Monster Table
            resetButtonGroup("monster-table-group");
            showGroup("monster-table-group");
            hideGroup("event-group");
            hideGroup("monster-select-group");

            const monsterTableRoll = randomNumber(1, 6);
            const tableFlavor = document.querySelector("#monster-table-group .flavor-text");
            const tableResult = document.querySelector("#monster-table-group .result-text");
            tableResult.textContent = monsterTableRoll;
            tableFlavor.textContent = monsterTableRoll <= 3 ? "Table A" : "Table B";
            monsterTableResult = monsterTableRoll <= 3 ? "A" : "B";
            showElement(tableFlavor);

            const monsterButton = document.getElementById("monster-select-group-btn");
            if (monsterButton) {
                monsterButton.textContent = `Monster (Table ${monsterTableResult} - d20)`;
                resetButtonGroup("monster-select-group");
            }
            showGroup("monster-select-group");

            // Monster Select
            const monsterRoll = randomNumber(1, 20);
            const monsterResultText = document.querySelector("#monster-select-group .result-text");
            const monsterFlavor = document.querySelector("#monster-select-group .flavor-text");
            monsterResultText.textContent = monsterRoll;
            const table = MONSTER_TABLES[monsterTableResult];
            const monster = table[monsterRoll] || "ERROR - INVALID ENTRY FROM MONSTER_TABLES";
            monsterFlavor.textContent = `${monster} (p. ${121 + monsterRoll})`;
            showElement(monsterFlavor);

        } else {
            // Event
            resetButtonGroup("event-group");
            showGroup("event-group");
            hideGroup("monster-table-group");
            hideGroup("monster-select-group");

            const eventRoll = randomNumber(1, 100);
            const eventResult = document.querySelector("#event-group .result-text");
            const eventFlavor = document.querySelector("#event-group .flavor-text");
            eventResult.textContent = eventRoll;
            const eventKey = (eventRoll <= 10) ? 1 : (eventRoll <= 20) ? 11 : (eventRoll <= 30) ? 21 : eventRoll;
            eventFlavor.textContent = EVENTS[eventKey] || "ERROR - INVALID ENTRY FROM EVENTS";
            showElement(eventFlavor);
        }
    };
}
</script>

<!-- Mechanisms Page Scripts -->
<script>
const DIFFICULTY_MODIFIER_CLASSES = {
    1: {diceValues: [1],    difficulty: "Child's Play", modifier: "+30"},
    2: {diceValues: [2],    difficulty: "Effortless",   modifier: "+20"},
    3: {diceValues: [3],    difficulty: "Easy",         modifier: "+10"},
    4: {diceValues: [4, 5], difficulty: "Normal",       modifier: "+0"},
    6: {diceValues: [6],    difficulty: "Demanding",    modifier: "-10"},
    7: {diceValues: [7],    difficulty: "Hard",         modifier: "-20"},
    8: {diceValues: [8],    difficulty: "Impossible",   modifier: "-30"}
};

const Mechanisms = {
    DOOR: {name: "Door", minLockThreshold: 12},
    CONTAINER: {name: "Container", minLockThreshold: 10}
};

let mechanismReportText = '';

function initMechanismsPage() {
    // Initialize any specific functionality for the Mechanisms page here
    console.log("Mechanisms page initialized.");
}

function rollDifficultyModifier() {
    let roll = randomNumber(1, 8);
    return Object.values(DIFFICULTY_MODIFIER_CLASSES).find(mod => mod.diceValues.includes(roll));
}

function isMechanismLocked(mechanism, diceRoll) {
    return diceRoll >= mechanism.minLockThreshold;
}

function isMechanismTrapped(diceRoll) {
    return diceRoll >= 7;
}

function rollMechanismExamination(mechanism) {
    let lockRoll = null;
    let isLocked = false;
    let trapRoll = null;
    let isTrapped = false;
    let lockDifficulty = null;
    let trapDifficulty = null;
    
    lockRoll = randomNumber(1, 20);
    isLocked = isMechanismLocked(mechanism, lockRoll);
    if (isLocked) {
        lockDifficulty = rollDifficultyModifier();
        
        trapRoll = randomNumber(1, 10);
        isTrapped = isMechanismTrapped(trapRoll);
        if (isTrapped) {
            trapDifficulty = rollDifficultyModifier();
        }
    }
    
    const result = {
        mechanism: mechanism,
        lockRoll: lockRoll,
        isLocked: isLocked,
        trapRoll: trapRoll,
        isTrapped: isTrapped,
        lockDifficulty: lockDifficulty,
        trapDifficulty: trapDifficulty
    }

    logMechanismReport(
        result.mechanism,
        result.lockRoll,
        result.isLocked,
        result.trapRoll,
        result.isTrapped,
        result.lockDifficulty,
        result.trapDifficulty
    );

    // Display the result in the UI
    displayMechanismMessage(result);
    displayDifficultyColumns(result);
}

function displayMechanismMessage(result) {
	const messageDiv = document.getElementById('mechanism-message');

	const lockedText = result.isLocked
		? `<span class="mechanism-is-locked txt-shadow">LOCKED</span>`
		: `NOT locked`;

    const lockRollText = `<span class="txt-shadow" style="color: white;">[${result.lockRoll}]</span>`;
    
	const trappedText = result.isTrapped
    ? `<span class="mechanism-is-trapped txt-shadow">TRAPPED</span>`
    : `NOT trapped`;

    const trapRollText = result.isTrapped
        ? `<span class="txt-shadow" style="color: white;"> [${result.trapRoll}]</span>`
        : ``;

    messageDiv.innerHTML = `The ${result.mechanism.name} is ${lockedText} ${lockRollText} and ${trappedText}${trapRollText}.`;
}

function displayDifficultyColumns(result) {
    const reportDetailsWrapper = document.getElementById('mechanism-report-details');

	const container = document.getElementById('difficulty-columns');
	container.innerHTML = ''; // Clear previous content

    if (!result.isLocked && !result.isTrapped) {
        reportDetailsWrapper.classList.add('hidden'); // Hide the container if no difficulties
        return;
    }

	if (result.isLocked) {
		const lockCol = document.createElement('div');
		lockCol.classList.add('difficulty-column');
		lockCol.innerHTML = `
			<div class="difficulty-label">LOCK</div>
			<div class="difficulty-detail">${result.lockDifficulty.difficulty} (${result.lockDifficulty.modifier})</div>
		`;
		container.appendChild(lockCol);

        reportDetailsWrapper.classList.remove('hidden'); // Show the container
	}

	if (result.isTrapped) {
		const trapCol = document.createElement('div');
		trapCol.classList.add('difficulty-column');
		trapCol.innerHTML = `
			<div class="difficulty-label">TRAP</div>
			<div class="difficulty-detail">${result.trapDifficulty.difficulty} (${result.trapDifficulty.modifier})</div>
		`;
		container.appendChild(trapCol);
	}
}

function rollDoorExamination() {
    rollMechanismExamination(Mechanisms.DOOR);
}

function rollContainerExamination() {
    rollMechanismExamination(Mechanisms.CONTAINER);
}
function logMechanismReport(mechanism, lockRoll, isLocked, trapRoll, isTrapped, lockDifficulty, trapDifficulty) {
    mechanismReportText = `Mechanism: ${mechanism.name}\n`;
    mechanismReportText += `Locked: ${isLocked ? "Yes" : "No"} (Rolled: ${lockRoll})\n`;
    if (isLocked) {
        mechanismReportText += `Lock Difficulty: ${lockDifficulty.difficulty} ${lockDifficulty.modifier}\n`;
        mechanismReportText += `Trapped: ${isTrapped ? "Yes" : "No"} (Rolled: ${trapRoll})\n`;
    }
    if (isTrapped) {
        mechanismReportText += `Trap Difficulty: ${trapDifficulty.difficulty} ${trapDifficulty.modifier}\n`;
    }
    
    console.log(mechanismReportText);
}

</script>



<!-- Combat Page Scripts -->
<script>

const CombatManager = (() => {
	let numPlayers = 1;
	const MAX_PLAYERS = 10;
	const MIN_PLAYERS = 1;
	let monsterActivities = [];

    const HitLocations = {
        RIGHT_LEG:  {name: "Right Leg", min: 1,     max: 3},
        LEFT_LEG:   {name: "Left Leg",  min: 4,     max: 6},
        ABDOMEN:    {name: "Abdomen",   min: 7,     max: 9},
        CHEST:      {name: "Chest",     min: 10,    max: 12},
        LEFT_ARM:   {name: "Left Arm",  min: 13,    max: 15},
        RIGHT_ARM:  {name: "Right Arm", min: 16,    max: 18},
        HEAD:       {name: "Head",      min: 19,    max: 20}
    };

	function addPlayer() {
		if (numPlayers < MAX_PLAYERS) numPlayers++;
	}

	function subtractPlayer() {
		if (numPlayers > MIN_PLAYERS) numPlayers--;
	}

	function resetPlayers() {
		numPlayers = 1;
	}

	function rollTarget() {
		return randomNumber(1, numPlayers);
	}

	function rollAction() {
		return randomNumber(1, 6);
	}

	function rollCombatCheck() {
		return randomNumber(1, 100);
	}

    function rollHitLocationResult() {
        const roll = randomNumber(1, 20);
        for (const location of Object.values(HitLocations)) {
            if (roll >= location.min && roll <= location.max) {
                return {
                    name: location.name,
                    roll: roll
                };
            }
        }
        return "UNKNOWN_HIT_LOCATION"; // Fallback
    }

	function generateMonsterActivity() {
        let date = new Date();
        let time = date.toLocaleString([], {
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
        });

		return {
            timestamp: time,
			target: rollTarget(),
			action: rollAction(),
			combatCheck: rollCombatCheck(),
            hitLocation: rollHitLocationResult()
		};
	}

	function appendMonsterActivity() {
		const activity = generateMonsterActivity();
		monsterActivities.push(activity);
		return activity;
	}

	function getMonsterActivityList() {
		return monsterActivities;
	}

	// Expose methods for use
	return {
        getNumPlayers: () => numPlayers,
		addPlayer,
		subtractPlayer,
		resetPlayers,
		rollTarget,
		rollAction,
		rollCombatCheck,
		generateMonsterActivity,
		appendMonsterActivity,
		getMonsterActivityList,
	};
})();


function initCombatPage() {
    // Initialize any specific functionality for the Combat page here
    console.log("Combat page initialized.");

    const addBtn = document.getElementById("add-player-button");
    const subBtn = document.getElementById("subtract-player-button");
    const resetBtn = document.getElementById("reset-players-button");
    const genActivityBtn = document.getElementById("generate-activity-button");
    // const playerCountSpan = document.getElementById("player-count-span");
    const playerCountTracker = document.getElementById("player-count-tracker");
    const logBox = document.getElementById("monster-log");
    const placeholderTextSpan = document.getElementById("monster-log-placeholder-text");
    const activityListEl = document.getElementById("monster-log-activity-list");

    function updatePlayerCountDisplay() {
	    const tracker = playerCountTracker;
        const numPlayers = CombatManager.getNumPlayers();
        
        // Clear existing icons
        tracker.innerHTML = "";

        // Add one icon per player
        for (let i = 0; i < numPlayers; i++) {
            const icon = document.createElement("span");
            icon.classList.add("material-symbols-outlined");
            icon.textContent = "chess_pawn"; // or any other icon name
            tracker.appendChild(icon);
        }
    }

    function updateLogDisplay() {
        const monsterActivities = CombatManager.getMonsterActivityList();
    
        // Track if the user is currently scrolled to the bottom
        const isAtBottom =
            logBox.scrollHeight - logBox.scrollTop <= logBox.clientHeight + 2;

        // Clear existing list items
        activityListEl.innerHTML = "";
    
        if (!monsterActivities || monsterActivities.length === 0) {
            placeholderTextSpan.textContent = "(No activities yet)";
            showElement(placeholderTextSpan);
            activityListEl.classList.add("hidden");
        } else {
            hideElement(placeholderTextSpan);
            activityListEl.classList.remove("hidden");
    
            monsterActivities.forEach((act, i) => {
                
                const timestamp = document.createElement("span");
                timestamp.textContent = `[${act.timestamp}]`;
                
                const data = document.createElement("pre");
                data.textContent = `Target: [${act.target}] → Action [${act.action}] → Check: [${act.combatCheck.toString().padStart(3)}] → Hit Location: ${act.hitLocation.name} [${act.hitLocation.roll}]`;
                
                const li = document.createElement("li");
                li.appendChild(timestamp);
                li.appendChild(document.createElement("br")); // Add a line break
                li.appendChild(data);

                // li.textContent = `[${act.timestamp}] Target: [${act.target}] → Action [${act.action}] → Check: [${act.combatCheck}] → Hit Location [${act.hitLocation}]`;
                activityListEl.appendChild(li);
            });
        }
        
        // Scroll to bottom if we were already at the bottom before
        if (isAtBottom) {
            logBox.scrollTop = logBox.scrollHeight;
        }
    }

    addBtn.addEventListener("click", () => {
        CombatManager.addPlayer();
        updatePlayerCountDisplay();
    });

    subBtn.addEventListener("click", () => {
        CombatManager.subtractPlayer();
        updatePlayerCountDisplay();
    });

    resetBtn.addEventListener("click", () => {
        CombatManager.resetPlayers();
        updatePlayerCountDisplay();
    });

    genActivityBtn.addEventListener("click", () => {
        CombatManager.appendMonsterActivity();
        updateLogDisplay();
    });

    // Init
    updatePlayerCountDisplay();
    updateLogDisplay();
}
</script>



<!-- View-Mode Scripts -->
<script>
const ViewModes = {
	HOME: "HOME",
	EXPLORATION: "EXPLORATION",
	MECHANISMS: "MECHANISMS",
	COMBAT: "COMBAT",
};

let currentViewMode = ViewModes.HOME; // default state is HOME
// let currentViewMode = ViewModes.EXPLORATION; 
// let currentViewMode = ViewModes.MECHANISMS; 
// let currentViewMode = ViewModes.COMBAT;

function initViewModeButtons() {
	const buttons = document.querySelectorAll('.viewmode-button');
	buttons.forEach(button => {
		button.addEventListener('click', () => {
			const selectedMode = button.dataset.mode;
			setViewMode(selectedMode);
		});
	});
	updateViewModeUI();
}

function setViewMode(mode) {
	if (!Object.values(ViewModes).includes(mode)) return;

	currentViewMode = mode;
	updateViewModeUI();

	// Hide all pages
	Object.values(PAGES).forEach(page => {
		page.classList.add("hidden");
	});

	// Show selected page
	const pageToShow = PAGES[currentViewMode];
	if (pageToShow) {
		pageToShow.classList.remove("hidden");
	}

	console.log("Switched to:", currentViewMode);
}

function updateViewModeUI() {
	document.querySelectorAll('.viewmode-button').forEach(btn => {
		if (btn.dataset.mode === currentViewMode) {
			btn.classList.add('active');
		} else {
			btn.classList.remove('active');
		}
	});
}

// Run on page load
window.addEventListener('DOMContentLoaded', () => {
	initViewModeButtons();
    setViewMode(currentViewMode); // Set initial view mode
});
</script>